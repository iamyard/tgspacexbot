#!/bin/bash

# ============================================
# –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê - –ó–ê–ü–û–õ–ù–ò–¢–ï –≠–¢–ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# ============================================
SERVER_IP="109.69.16.218"        # IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
SERVER_USER="root"                # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
SERVER_PASS="LcLBrkotSeoI!2"       # –ü–∞—Ä–æ–ª—å –¥–ª—è SSH

# ============================================

# –ù–ï –ú–ï–ù–Ø–ô–¢–ï –ù–ò–ß–ï–ì–û –ù–ò–ñ–ï –≠–¢–û–ô –°–¢–†–û–ö–ò
# ============================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Homebrew –¥–ª—è macOS (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ –≤ PATH)
if [[ "$OSTYPE" == "darwin"* ]]; then
    if [ -f "/opt/homebrew/bin/brew" ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [ -f "/usr/local/bin/brew" ]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
run_remote() {
    sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" "$1"
}

echo "=========================================="
echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–û–¢–ê –ù–ê –°–ï–†–í–ï–†–ï"
echo "=========================================="
echo ""

echo "üì° –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É $SERVER_USER@$SERVER_IP..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if ! run_remote "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" >/dev/null 2>&1; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi

echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞..."
run_remote "
    if [ -d ~/telegram-bot ]; then
        echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ~/telegram-bot —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
        cd ~/telegram-bot && pwd
    else
        echo '‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ~/telegram-bot –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
    fi
"
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
echo "üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤..."
run_remote "
    cd ~/telegram-bot 2>/dev/null && {
        echo '–§–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:'
        ls -la | head -20
        echo ''
        echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:'
        [ -f bot.py ] && echo '‚úÖ bot.py —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' || echo '‚ùå bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω'
        [ -f config.py ] && echo '‚úÖ config.py —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' || echo '‚ùå config.py –Ω–µ –Ω–∞–π–¥–µ–Ω'
        [ -f requirements.txt ] && echo '‚úÖ requirements.txt —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' || echo '‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω'
        [ -f .env ] && echo '‚úÖ .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' || echo '‚ùå .env –Ω–µ –Ω–∞–π–¥–µ–Ω'
        [ -f start_bot.sh ] && echo '‚úÖ start_bot.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' || echo '‚ùå start_bot.sh –Ω–µ –Ω–∞–π–¥–µ–Ω'
    }
"
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø–æ–∫–∞–∑–∞ –ø–∞—Ä–æ–ª—è)
echo "‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (.env)..."
run_remote "
    cd ~/telegram-bot 2>/dev/null && {
        if [ -f .env ]; then
            echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env (—Å–∫—Ä—ã—Ç —Ç–æ–∫–µ–Ω):'
            sed 's/BOT_TOKEN=.*/BOT_TOKEN=***/' .env | sed 's/SERVER_PASS=.*/SERVER_PASS=***/'
        else
            echo '‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω'
        fi
    }
"
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."
run_remote "
    echo '–ü—Ä–æ—Ü–µ—Å—Å—ã Python, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –±–æ—Ç–æ–º:'
    ps aux | grep -E '[p]ython.*bot|[b]ot\.py' || echo '‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
    echo ''
    if [ -f ~/telegram-bot/bot.pid ]; then
        PID=\$(cat ~/telegram-bot/bot.pid 2>/dev/null)
        echo 'PID –∏–∑ —Ñ–∞–π–ª–∞ bot.pid: '\$PID
        if ps -p \$PID >/dev/null 2>&1; then
            echo '‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Å PID '\$PID' –∑–∞–ø—É—â–µ–Ω'
        else
            echo '‚ùå –ü—Ä–æ—Ü–µ—Å—Å —Å PID '\$PID' –Ω–µ –Ω–∞–π–¥–µ–Ω'
        fi
    else
        echo '‚ö†Ô∏è  –§–∞–π–ª bot.pid –Ω–µ –Ω–∞–π–¥–µ–Ω'
    fi
"
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ –±–æ—Ç–∞..."
run_remote "
    cd ~/telegram-bot 2>/dev/null && {
        if [ -f bot.log ]; then
            echo '=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ bot.log ==='
            tail -30 bot.log
        else
            echo '‚ö†Ô∏è  –§–∞–π–ª bot.log –Ω–µ –Ω–∞–π–¥–µ–Ω'
        fi
    }
"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
run_remote "
    echo '–í–µ—Ä—Å–∏—è Python:'
    python3 --version 2>&1 || echo '‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω'
    echo ''
    echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤:'
    pip3 list 2>/dev/null | grep -E 'aiogram|Pillow|python-dotenv' || echo '‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'
"
echo ""

# 7. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
echo "üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞..."
run_remote "
    cd ~/telegram-bot 2>/dev/null && {
        if [ -f start_bot.sh ]; then
            echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ start_bot.sh:'
            cat start_bot.sh
            echo ''
            if [ -x start_bot.sh ]; then
                echo '‚úÖ –°–∫—Ä–∏–ø—Ç start_bot.sh –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π'
            else
                echo '‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç start_bot.sh –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π'
            fi
        fi
    }
"
echo ""

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
run_remote "
    cd ~/telegram-bot 2>/dev/null && {
        echo '–ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã:'
        ls -la bot.py start_bot.sh .env 2>/dev/null | awk '{print \$1, \$9}'
    }
"
echo ""

echo "=========================================="
echo "‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=========================================="
echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   1. –ï—Å–ª–∏ .env –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç - –∑–∞–ø—É—Å—Ç–∏—Ç–µ setup.sh"
echo "   2. –ï—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: pip3 install -r requirements.txt"
echo "   3. –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./start_bot.sh"
echo "   4. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏: tail -f bot.log"
echo ""






